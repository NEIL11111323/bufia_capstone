{% extends 'base.html' %}
{% load static %}

{% block title %}Members Masterlist - BUFIA Management System{% endblock %}

{% block extra_css %}
<style>
    .masterlist-container {
        max-width: 100%;
        margin: 0 auto;
        padding: 2rem 1rem;
    }
    
    .masterlist-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 2rem;
    }
    
    .masterlist-title {
        font-size: 1.75rem;
        font-weight: 700;
        color: #212529 !important;
        margin-bottom: 0.25rem;
    }
    
    .masterlist-subtitle {
        color: #6c757d !important;
        font-size: 1rem;
    }
    
    .masterlist-card {
        background-color: white;
        border-radius: 12px;
        box-shadow: 0 5px 20px rgba(0,0,0,0.05);
        overflow: hidden;
        margin-bottom: 2rem;
        border: none;
    }
    
    .masterlist-card-header {
        background-color: var(--primary-light);
        padding: 1.5rem;
        border-bottom: 1px solid rgba(0,0,0,0.05);
    }
    
    .masterlist-card-title {
        color: #019d66 !important;
        font-weight: 600;
        margin-bottom: 0;
        font-size: 1.25rem;
        display: flex;
        align-items: center;
    }
    
    .masterlist-card-title i {
        margin-right: 0.75rem;
    }
    
    .masterlist-card-body {
        padding: 1.5rem;
    }
    
    .table-responsive {
        overflow-x: auto;
    }
    
    .masterlist-table {
        width: 100%;
        border-collapse: collapse;
        font-size: 0.9rem;
    }
    
    .masterlist-table th {
        background-color: #f8f9fa;
        padding: 12px 15px;
        text-align: left;
        font-weight: 600;
        color: #212529 !important;
        border: 1px solid #dee2e6;
        position: sticky;
        top: 0;
        z-index: 10;
    }
    
    .masterlist-table td {
        padding: 10px 15px;
        border: 1px solid #dee2e6;
        vertical-align: middle;
        color: #212529 !important;
    }
    
    .masterlist-table tr:nth-child(even) {
        background-color: #f8f9fa;
    }
    
    .masterlist-table tr:hover {
        background-color: #e9ecef;
    }
    
    .sector-tabs .nav-link {
        color: #6c757d !important;
        font-weight: 600;
        padding: 12px 20px;
        border-radius: 0;
        border: none;
        position: relative;
    }
    
    .sector-tabs .nav-link.active {
        color: #019d66 !important;
        background-color: transparent;
    }
    
    .sector-tabs .nav-link.active::after {
        content: '';
        position: absolute;
        bottom: 0;
        left: 0;
        width: 100%;
        height: 3px;
        background-color: var(--primary);
    }
    
    .tab-content {
        padding: 20px 0;
    }
    
    .export-btn {
        display: inline-flex;
        align-items: center;
        justify-content: center;
        padding: 10px 20px;
        background-color: #019d66 !important;
        color: white !important;
        border-radius: 8px;
        font-weight: 600;
        font-size: 14px;
        text-decoration: none !important;
        border: none;
        cursor: pointer;
        transition: all 0.3s ease;
        box-shadow: 0 2px 4px rgba(1, 157, 102, 0.2);
        min-width: 160px;
    }
    
    .export-btn:hover {
        background-color: #017a4f !important;
        transform: translateY(-2px);
        color: white !important;
        box-shadow: 0 4px 8px rgba(1, 157, 102, 0.3);
        text-decoration: none !important;
    }
    
    .export-btn:active {
        transform: translateY(0);
        box-shadow: 0 1px 2px rgba(1, 157, 102, 0.2);
    }
    
    .export-btn i {
        margin-right: 8px;
        font-size: 16px;
    }
    
    @media print {
        .no-print {
            display: none;
        }
        
        .masterlist-container {
            padding: 0;
        }
        
        .masterlist-card {
            box-shadow: none;
            border-radius: 0;
        }
        
        .masterlist-table th, .masterlist-table td {
            padding: 6px 10px;
            font-size: 10pt;
        }
    }
    
    .action-btn-sm {
        padding: 0.25rem 0.5rem;
        font-size: 0.75rem;
    }
    .nav-tabs .nav-link {
        cursor: pointer;
    }
    
    /* Fix for white text visibility */
    .masterlist-container h4,
    .masterlist-container p,
    .masterlist-container td,
    .masterlist-container th,
    .masterlist-container .text-center {
        color: #212529 !important;
    }
    
    .masterlist-container .btn-group .btn {
        color: inherit !important;
    }
    
    .masterlist-container .btn-outline-primary {
        color: #019d66 !important;
    }
    
    .masterlist-container .btn-outline-secondary {
        color: #6c757d !important;
    }
    
    .masterlist-container .btn-outline-danger {
        color: #dc3545 !important;
    }
</style>
{% endblock %}

{% block content %}
<div class="masterlist-container" data-active-sector-id="{{ active_sector_id|default_if_none:'' }}">
    <!-- Masterlist Header -->
    <div class="masterlist-header">
        <div>
            <h1 class="masterlist-title"><i class="fas fa-list-alt me-2"></i>Members Masterlist</h1>
            <p class="masterlist-subtitle">Comprehensive list of all BUFIA members by sector</p>
        </div>
        
        <div class="no-print">
            <a href="{% url 'export_members_csv' %}" id="export-csv-btn" class="export-btn me-2">
                <i class="fas fa-file-csv"></i> Export to CSV
            </a>
            <a href="{% url 'export_members_pdf' %}" id="export-pdf-btn" class="export-btn me-2">
                <i class="fas fa-file-pdf"></i> Export to PDF
            </a>
            <a href="javascript:void(0)" onclick="printCurrentTab()" class="export-btn">
                <i class="fas fa-print"></i> Print
            </a>
        </div>
    </div>
    
    <!-- Masterlist Card -->
    <div class="masterlist-card">
        <div class="masterlist-card-header no-print">
            <ul class="nav nav-tabs sector-tabs" id="sectorTabs" role="tablist">
                <li class="nav-item" role="presentation">
                    <button class="nav-link" id="all-tab" data-bs-toggle="tab" data-bs-target="#all-members-pane" type="button" role="tab" aria-controls="all-members-pane" aria-selected="false">
                        All Members
                    </button>
                </li>
                {% for sector_item in sectors_data %}
                <li class="nav-item" role="presentation">
                    <button class="nav-link" id="sector-{{ sector_item.id }}-tab" data-bs-toggle="tab" data-bs-target="#sector-{{ sector_item.id }}-pane" type="button" role="tab" aria-controls="sector-{{ sector_item.id }}-pane" aria-selected="false">
                        {{ sector_item.name }}
                    </button>
                </li>
                {% endfor %}
            </ul>
        </div>
        <div class="masterlist-card-body">
            <div class="tab-content" id="sectorTabsContent">
                <!-- All Members Tab -->
                <div class="tab-pane fade" id="all-members-pane" role="tabpanel" aria-labelledby="all-tab">
                    <div class="table-responsive">
                        <table class="masterlist-table">
                            <thead>
                                <tr>
                                    <th>NO.</th>
                                    <th>NAME OF FARMER</th>
                                    <th>ACTIONS</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for member in all_verified_members %}
                                <tr>
                                    <td>{{ forloop.counter }}</td>
                                    <td>{{ member.user.last_name }}, {{ member.user.first_name }} {{ member.middle_name|default:'' }}</td>
                                    <td>
                                        <div class="btn-group" role="group" aria-label="Member Actions">
                                            <a href="{% url 'view_membership_info_user' user_id=member.user.id %}" class="btn btn-sm btn-outline-primary action-btn-sm">
                                                <i class="fas fa-eye me-1"></i> View
                                            </a>
                                            <a href="{% url 'edit_user' member.user.id %}" class="btn btn-sm btn-outline-secondary action-btn-sm">
                                                <i class="fas fa-edit me-1"></i> Edit
                                            </a>
                                            <a href="{% url 'delete_user' member.user.id %}" class="btn btn-sm btn-outline-danger action-btn-sm">
                                                <i class="fas fa-trash me-1"></i> Delete
                                            </a>
                                        </div>
                                    </td>
                                </tr>
                                {% empty %}
                                <tr>
                                    <td colspan="3" class="text-center py-4">No members found</td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                </div>
                
                <!-- Sector Tabs -->
                {% for sector_item in sectors_data %}
                <div class="tab-pane fade" id="sector-{{ sector_item.id }}-pane" role="tabpanel" aria-labelledby="sector-{{ sector_item.id }}-tab">
                    <h4>{{ sector_item.name }} Members</h4>
                    <p>{{ sector_item.description|default:"No description provided." }}</p>
                    <div class="table-responsive">
                        <table class="masterlist-table">
                            <thead>
                                <tr>
                                    <th>NO.</th>
                                    <th>NAME OF FARMER</th>
                                    <th>ACTIONS</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for member in sector_item.members %}
                                <tr>
                                    <td>{{ forloop.counter }}</td>
                                    <td>{{ member.user.last_name }}, {{ member.user.first_name }} {{ member.middle_name|default:'' }}</td>
                                    <td>
                                        <div class="btn-group" role="group" aria-label="Member Actions">
                                            <a href="{% url 'view_membership_info_user' user_id=member.user.id %}" class="btn btn-sm btn-outline-primary action-btn-sm">
                                                <i class="fas fa-eye me-1"></i> View
                                            </a>
                                            <a href="{% url 'edit_user' member.user.id %}" class="btn btn-sm btn-outline-secondary action-btn-sm">
                                                <i class="fas fa-edit me-1"></i> Edit
                                            </a>
                                            <a href="{% url 'delete_user' member.user.id %}" class="btn btn-sm btn-outline-danger action-btn-sm">
                                                <i class="fas fa-trash me-1"></i> Delete
                                            </a>
                                        </div>
                                    </td>
                                </tr>
                                {% empty %}
                                <tr>
                                    <td colspan="3" class="text-center py-4">No members found in {{ sector_item.name }}</td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                </div>
                {% endfor %}
            </div>
        </div>
    </div>
</div>

{% include 'users/partials/user_profile_modal.html' %}

{% endblock %}

{% block extra_js %}
<script>
let currentActiveSector = null;

document.addEventListener('DOMContentLoaded', function () {
    const container = document.querySelector('.masterlist-container');
    const activeSectorId = container.dataset.activeSectorId;
    const defaultTabId = 'all-tab';
    const defaultPaneId = 'all-members-pane';

    let targetTabId = defaultTabId;
    let targetPaneId = defaultPaneId;

    if (activeSectorId && activeSectorId !== 'unassigned') {
        targetTabId = `sector-${activeSectorId}-tab`;
        targetPaneId = `sector-${activeSectorId}-pane`;
        currentActiveSector = activeSectorId;
    } else if (activeSectorId === 'unassigned') {
        targetTabId = `sector-unassigned-tab`;
        targetPaneId = `sector-unassigned-pane`;
        currentActiveSector = 'unassigned';
    } else {
        currentActiveSector = 'all';
    }

    const targetTabButton = document.getElementById(targetTabId);
    const targetPane = document.getElementById(targetPaneId);

    // Deactivate all tabs and panes first
    document.querySelectorAll('.sector-tabs .nav-link').forEach(button => {
        button.classList.remove('active');
        button.setAttribute('aria-selected', 'false');
    });
    document.querySelectorAll('.tab-content .tab-pane').forEach(pane => {
        pane.classList.remove('show', 'active');
    });

    // Activate the target tab and pane
    if (targetTabButton && targetPane) {
        targetTabButton.classList.add('active');
        targetTabButton.setAttribute('aria-selected', 'true');
        targetPane.classList.add('show', 'active');
    } else {
        document.getElementById(defaultTabId)?.classList.add('active');
        document.getElementById(defaultTabId)?.setAttribute('aria-selected', 'true');
        document.getElementById(defaultPaneId)?.classList.add('show', 'active');
    }

    // Update export links when tab changes
    document.querySelectorAll('.sector-tabs .nav-link').forEach(button => {
        button.addEventListener('click', function() {
            const targetId = this.getAttribute('data-bs-target');
            
            if (targetId === '#all-members-pane') {
                currentActiveSector = 'all';
            } else if (targetId.includes('unassigned')) {
                currentActiveSector = 'unassigned';
            } else {
                const match = targetId.match(/sector-(\d+)-pane/);
                if (match) {
                    currentActiveSector = match[1];
                }
            }
            
            updateExportLinks();
        });
    });

    updateExportLinks();
});

function updateExportLinks() {
    const csvBtn = document.getElementById('export-csv-btn');
    const pdfBtn = document.getElementById('export-pdf-btn');
    
    if (currentActiveSector === 'all') {
        csvBtn.href = '{% url "export_members_csv" %}';
        pdfBtn.href = '{% url "export_members_pdf" %}';
    } else {
        csvBtn.href = `{% url "export_members_csv" %}?sector=${currentActiveSector}`;
        pdfBtn.href = `{% url "export_members_pdf" %}?sector=${currentActiveSector}`;
    }
}

function printCurrentTab() {
    // Hide all tab panes except the active one
    const allPanes = document.querySelectorAll('.tab-pane');
    allPanes.forEach(pane => {
        if (!pane.classList.contains('active')) {
            pane.style.display = 'none';
        }
    });
    
    // Print
    window.print();
    
    // Restore all panes after printing
    setTimeout(() => {
        allPanes.forEach(pane => {
            pane.style.display = '';
        });
    }, 100);
}
</script>
{% endblock %} 