{% extends 'base.html' %}
{% load static %}

{% block title %}Rental Details - BUFIA{% endblock %}

{% block extra_css %}
<link href="{% static 'css/bufia-design-system.css' %}" rel="stylesheet">
<style>
    .detail-card {
        border: none;
        box-shadow: 0 2px 8px rgba(0,0,0,0.1);
    }
    
    .detail-header {
        background: linear-gradient(135deg, #00a86b 0%, #007c4f 100%);
        color: white;
        padding: 1.5rem;
        border-radius: 12px 12px 0 0;
    }
    
    .info-section {
        background: #f9fafb;
        border-radius: 8px;
        padding: 1.5rem;
        margin-bottom: 1.5rem;
    }
    
    .info-section h5 {
        color: #00a86b;
        font-weight: 600;
        margin-bottom: 1rem;
        padding-bottom: 0.5rem;
        border-bottom: 2px solid #00a86b;
    }
    
    .detail-row {
        display: flex;
        justify-content: space-between;
        padding: 0.75rem 0;
        border-bottom: 1px solid #e5e7eb;
    }
    
    .detail-row:last-child {
        border-bottom: none;
    }
    
    .detail-label {
        font-weight: 600;
        color: #6b7280;
    }
    
    .detail-value {
        color: #1f2937;
        text-align: right;
    }
    
    .purpose-box {
        background: white;
        border: 1px solid #e5e7eb;
        border-radius: 8px;
        padding: 1rem;
        white-space: pre-wrap;
        font-family: inherit;
        line-height: 1.6;
    }
    
    .cost-highlight {
        background: #ecfdf5;
        border: 2px solid #10b981;
        border-radius: 8px;
        padding: 1rem;
        text-align: center;
    }
</style>
{% endblock %}

{% block content %}
<div class="container py-4">
    <div class="mb-4">
        <a href="{% url 'machines:rental_list' %}" class="btn btn-outline-secondary">
            <i class="fas fa-arrow-left me-2"></i>Back to My Rentals
        </a>
    </div>
    
    <div class="card detail-card">
        <div class="detail-header">
            <h3 class="mb-0"><i class="fas fa-file-alt me-2"></i>Rental Details</h3>
        </div>
        <div class="card-body p-4">
            <div class="row">
                <!-- Equipment Information -->
                <div class="col-md-6 mb-4">
                    <div class="info-section">
                        <h5>Equipment Information</h5>
                        <div class="detail-row">
                            <span class="detail-label">Machine:</span>
                            <span class="detail-value fw-bold">{{ rental.machine.name }}</span>
                        </div>
                        <div class="detail-row">
                            <span class="detail-label">Type:</span>
                            <span class="detail-value">{{ rental.machine.get_machine_type_display }}</span>
                        </div>
                        <div class="detail-row">
                            <span class="detail-label">Rate:</span>
                            <span class="detail-value">{{ rental.machine.current_price }}</span>
                        </div>
                    </div>
                </div>
                
                <!-- Rental Period -->
                <div class="col-md-6 mb-4">
                    <div class="info-section">
                        <h5>Rental Period</h5>
                        <div class="detail-row">
                            <span class="detail-label">Start Date:</span>
                            <span class="detail-value">{{ rental.start_date|date:"F d, Y" }}</span>
                        </div>
                        <div class="detail-row">
                            <span class="detail-label">End Date:</span>
                            <span class="detail-value">{{ rental.end_date|date:"F d, Y" }}</span>
                        </div>
                        <div class="detail-row">
                            <span class="detail-label">Duration:</span>
                            <span class="detail-value fw-bold">{{ rental.get_duration_days }} day{{ rental.get_duration_days|pluralize }}</span>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Total Cost Highlight -->
            <div class="row mb-4">
                <div class="col-12">
                    <div class="cost-highlight">
                        <div class="text-muted mb-1">Estimated Total Cost</div>
                        <h3 class="text-success mb-0">{{ rental.machine.current_price }}</h3>
                        <small class="text-muted">Based on {{ rental.get_duration_days }} day{{ rental.get_duration_days|pluralize }}</small>
                    </div>
                </div>
            </div>
            
            <div class="row">
                <!-- Status Information -->
                <div class="col-md-6 mb-4">
                    <div class="info-section">
                        <h5>Status</h5>
                        <div class="detail-row">
                            <span class="detail-label">Booking Status:</span>
                            <span class="detail-value">
                                {% if rental.status == 'approved' %}
                                    <span class="badge bg-success">Approved</span>
                                {% elif rental.status == 'pending' %}
                                    <span class="badge bg-warning">Pending</span>
                                {% elif rental.status == 'rejected' %}
                                    <span class="badge bg-danger">Rejected</span>
                                {% elif rental.status == 'cancelled' %}
                                    <span class="badge bg-secondary">Cancelled</span>
                                {% endif %}
                            </span>
                        </div>
                        <div class="detail-row">
                            <span class="detail-label">Payment Status:</span>
                            <span class="detail-value">
                                {% if rental.payment_verified %}
                                    <span class="badge bg-success">Verified</span>
                                {% else %}
                                    <span class="badge bg-warning">Pending Verification</span>
                                {% endif %}
                            </span>
                        </div>
                        {% if rental.get_transaction_id %}
                        <div class="detail-row bg-light">
                            <span class="detail-label">
                                <i class="fas fa-receipt me-1"></i>Transaction ID:
                            </span>
                            <span class="detail-value fw-bold text-success" style="font-family: 'Courier New', monospace;">
                                {{ rental.get_transaction_id }}
                            </span>
                        </div>
                        {% endif %}
                        {% if rental.payment_method %}
                        <div class="detail-row">
                            <span class="detail-label">Payment Method:</span>
                            <span class="detail-value">
                                {% if rental.payment_method == 'online' %}
                                    <i class="fas fa-credit-card text-primary me-1"></i>Online
                                {% else %}
                                    <i class="fas fa-handshake text-success me-1"></i>Face-to-Face
                                {% endif %}
                            </span>
                        </div>
                        {% endif %}
                        <div class="detail-row">
                            <span class="detail-label">Requested On:</span>
                            <span class="detail-value">{{ rental.created_at|date:"F d, Y g:i A" }}</span>
                        </div>
                    </div>
                </div>
                
                <!-- Purpose/Additional Information -->
                <div class="col-md-6 mb-4">
                    <div class="info-section">
                        <h5>Purpose & Additional Information</h5>
                        {% if rental.purpose %}
                            <div class="purpose-box">{{ rental.purpose }}</div>
                        {% else %}
                            <p class="text-muted">No additional information provided.</p>
                        {% endif %}
                    </div>
                    
                    {% if rental.payment_slip %}
                    <div class="mt-3">
                        <button type="button" class="btn btn-outline-primary w-100" onclick="event.preventDefault(); openProofModal('{{ rental.payment_slip.url }}', '{{ rental.user.get_full_name }}', '{{ rental.machine.name }}'); return false;">
                            <i class="fas fa-file-image me-2"></i>View Payment Proof
                        </button>
                    </div>
                    {% endif %}
                </div>
            </div>
            
            <!-- Action Buttons -->
            <div class="d-flex gap-2 mt-4">
                {% if rental.status == 'pending' and not rental.payment_verified and rental.payment_method == 'online' %}
                    {% if rental.machine.stripe_payment_link %}
                        <a href="{{ rental.machine.stripe_payment_link }}" target="_blank" class="btn btn-primary">
                            <i class="fas fa-credit-card me-2"></i>Complete Payment
                        </a>
                    {% else %}
                        <a href="{% url 'create_rental_payment' rental.id %}" class="btn btn-primary">
                            <i class="fas fa-credit-card me-2"></i>Complete Payment
                        </a>
                    {% endif %}
                {% endif %}
                <button onclick="window.print()" class="btn btn-outline-secondary">
                    <i class="fas fa-print me-2"></i>Print
                </button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
// Image Modal Functions
function openProofModal(imageUrl, userName, machineName) {
    // Prevent default browser behavior
    event.preventDefault();
    event.stopPropagation();
    
    const modal = document.getElementById('proofModal');
    const modalImg = document.getElementById('modalProofImage');
    const caption = document.getElementById('modalCaption');
    
    modal.style.display = 'block';
    modalImg.src = imageUrl;
    caption.textContent = `Payment Proof - ${userName} - ${machineName}`;
    
    // Prevent body scroll when modal is open
    document.body.style.overflow = 'hidden';
    
    return false;
}

function closeProofModal() {
    const modal = document.getElementById('proofModal');
    modal.style.display = 'none';
    
    // Restore body scroll
    document.body.style.overflow = 'auto';
}

// Close modal when clicking outside the image
window.onclick = function(event) {
    const modal = document.getElementById('proofModal');
    if (event.target == modal) {
        closeProofModal();
    }
}

// Close modal with Escape key
document.addEventListener('keydown', function(event) {
    if (event.key === 'Escape') {
        closeProofModal();
    }
});
</script>

<!-- Payment Proof Modal - Green Theme -->
<div id="proofModal" style="display: none; position: fixed; z-index: 9999; left: 0; top: 0; width: 100%; height: 100%; overflow: auto; background-color: rgba(1, 157, 102, 0.15); backdrop-filter: blur(4px);">
    <div style="display: flex; justify-content: center; align-items: center; height: 100%; padding: 20px;">
        <div style="background: white; border-radius: 16px; box-shadow: 0 8px 32px rgba(1, 157, 102, 0.3); max-width: 90%; max-height: 90%; overflow: hidden; border: 3px solid #019d66;">
            <!-- Modal Header -->
            <div style="background: linear-gradient(135deg, #019d66 0%, #017a4f 100%); color: white; padding: 1.5rem; display: flex; justify-content: space-between; align-items: center;">
                <div>
                    <h4 style="margin: 0; font-weight: 600; font-size: 1.25rem;">
                        <i class="fas fa-receipt" style="margin-right: 0.5rem;"></i>Payment Proof
                    </h4>
                    <p id="modalCaption" style="margin: 0.5rem 0 0 0; font-size: 0.9rem; opacity: 0.9;"></p>
                </div>
                <button onclick="closeProofModal()" style="background: rgba(255,255,255,0.2); border: none; color: white; width: 40px; height: 40px; border-radius: 50%; cursor: pointer; font-size: 24px; display: flex; align-items: center; justify-content: center; transition: all 0.2s;" onmouseover="this.style.background='rgba(255,255,255,0.3)'" onmouseout="this.style.background='rgba(255,255,255,0.2)'">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            
            <!-- Modal Body -->
            <div style="padding: 2rem; text-align: center; max-height: calc(90vh - 120px); overflow-y: auto;">
                <img id="modalProofImage" src="" style="max-width: 100%; height: auto; border-radius: 8px; box-shadow: 0 4px 20px rgba(0,0,0,0.15); border: 2px solid #e9ecef;" alt="Payment Proof">
            </div>
            
            <!-- Modal Footer -->
            <div style="background: #f8f9fa; padding: 1rem 1.5rem; border-top: 1px solid #e9ecef; display: flex; justify-content: flex-end; gap: 0.5rem;">
                <button onclick="closeProofModal()" style="background: #6c757d; color: white; border: none; padding: 0.5rem 1.5rem; border-radius: 6px; cursor: pointer; font-weight: 500; transition: all 0.2s;" onmouseover="this.style.background='#5a6268'" onmouseout="this.style.background='#6c757d'">
                    <i class="fas fa-times me-2"></i>Close
                </button>
            </div>
        </div>
    </div>
</div>
{% endblock %}
