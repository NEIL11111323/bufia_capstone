# Requirements Document

## Introduction

This specification defines a dual transaction ID system for the BUFIA rental payment platform. The system will maintain both internal business transaction IDs and external Stripe payment IDs to ensure proper payment tracking, reconciliation, auditability, and future scalability. This approach follows industry best practices for payment systems by separating business logic identifiers from payment processor identifiers.

## Glossary

- **Payment System**: The BUFIA rental payment processing and tracking system
- **Internal Transaction ID**: A human-readable, business-specific identifier generated by the BUFIA system (format: BUF-TXN-YYYY-NNNNN)
- **Stripe Transaction ID**: External payment identifiers generated by Stripe (payment_intent_id, charge_id, checkout_session_id)
- **Rental**: A machine rental booking in the BUFIA system
- **Payment Record**: A database entry tracking payment information for a rental
- **Receipt**: A document provided to users showing payment confirmation
- **Admin Dashboard**: The administrative interface for managing rentals and payments
- **Reconciliation**: The process of matching internal payment records with Stripe payment records

## Requirements

### Requirement 1

**User Story:** As a BUFIA user, I want to receive a clear, professional transaction ID on my receipt, so that I can easily reference my payment when communicating with staff.

#### Acceptance Criteria

1. WHEN a user completes a payment THEN the Payment System SHALL generate a unique internal transaction ID in the format BUF-TXN-YYYY-NNNNN where YYYY is the current year and NNNNN is a zero-padded sequential number
2. WHEN a receipt is displayed to a user THEN the Payment System SHALL show the internal transaction ID prominently
3. WHEN a user views their rental details THEN the Payment System SHALL display the internal transaction ID
4. THE Payment System SHALL ensure internal transaction IDs are sequential within each calendar year
5. WHEN a new calendar year begins THEN the Payment System SHALL reset the sequential counter to 00001

### Requirement 2

**User Story:** As a BUFIA administrator, I want to track both internal and Stripe transaction IDs, so that I can reconcile payments and handle disputes effectively.

#### Acceptance Criteria

1. WHEN a payment is processed through Stripe THEN the Payment System SHALL store the Stripe payment_intent_id in the payment record
2. WHEN a payment is processed through Stripe THEN the Payment System SHALL store the Stripe charge_id in the payment record
3. WHEN an administrator views payment details THEN the Payment System SHALL display both the internal transaction ID and all associated Stripe IDs
4. WHEN an administrator searches for a payment THEN the Payment System SHALL support searching by either internal transaction ID or Stripe transaction ID
5. THE Payment System SHALL maintain a foreign key relationship between payment records and rental records

### Requirement 3

**User Story:** As a BUFIA administrator, I want the system to automatically link Stripe payments to internal records, so that payment status updates are accurate and timely.

#### Acceptance Criteria

1. WHEN a Stripe webhook event is received THEN the Payment System SHALL locate the corresponding payment record using the Stripe payment_intent_id
2. WHEN a payment succeeds in Stripe THEN the Payment System SHALL update the payment status to "Paid" automatically
3. WHEN a payment fails in Stripe THEN the Payment System SHALL update the payment status to "Failed" automatically
4. WHEN a refund is processed in Stripe THEN the Payment System SHALL record the refund against the correct internal transaction ID
5. THE Payment System SHALL log all webhook events with both internal and Stripe transaction IDs for audit purposes

### Requirement 4

**User Story:** As a BUFIA database administrator, I want a properly structured payment schema, so that data integrity is maintained and queries are efficient.

#### Acceptance Criteria

1. THE Payment System SHALL store payment records in a dedicated Payments table separate from the Rentals table
2. THE Payments table SHALL include fields for payment_id, internal_transaction_id, stripe_payment_intent_id, stripe_charge_id, rental_id, amount, payment_status, and payment_date
3. THE Payment System SHALL enforce uniqueness constraints on internal_transaction_id
4. THE Payment System SHALL enforce uniqueness constraints on stripe_payment_intent_id when not null
5. THE Payment System SHALL create database indexes on internal_transaction_id and stripe_payment_intent_id for query performance
6. THE Payment System SHALL use a foreign key constraint linking rental_id to the Rentals table

### Requirement 5

**User Story:** As a BUFIA system architect, I want the transaction ID system to be payment-processor agnostic, so that we can switch providers in the future without breaking existing records.

#### Acceptance Criteria

1. THE Payment System SHALL use internal transaction IDs as the primary identifier for all business logic
2. WHEN displaying payment information to users THEN the Payment System SHALL show only the internal transaction ID unless specifically viewing payment processor details
3. WHEN generating reports THEN the Payment System SHALL use internal transaction IDs as the primary reference
4. THE Payment System SHALL store payment processor identifiers in separate, nullable fields
5. THE Payment System SHALL allow payment records to exist with internal transaction IDs even if external payment processor IDs are not yet available

### Requirement 6

**User Story:** As a BUFIA accountant, I want to generate financial reports using internal transaction IDs, so that I can perform accounting and reconciliation tasks efficiently.

#### Acceptance Criteria

1. WHEN generating a payment report THEN the Payment System SHALL include the internal transaction ID for each payment
2. WHEN exporting payment data THEN the Payment System SHALL include both internal and Stripe transaction IDs in separate columns
3. WHEN filtering payments by date range THEN the Payment System SHALL return results ordered by internal transaction ID
4. THE Payment System SHALL provide a reconciliation view showing internal transaction IDs alongside Stripe transaction IDs
5. WHEN a payment record is created THEN the Payment System SHALL timestamp the creation with payment_date

### Requirement 7

**User Story:** As a BUFIA developer, I want clear migration paths for existing payment data, so that historical records are preserved when implementing the new system.

#### Acceptance Criteria

1. WHEN migrating existing payment data THEN the Payment System SHALL generate internal transaction IDs for all historical payments
2. WHEN migrating existing payment data THEN the Payment System SHALL preserve existing Stripe transaction IDs
3. WHEN migrating existing payment data THEN the Payment System SHALL maintain the chronological order of payments when assigning sequential numbers
4. THE Payment System SHALL provide a migration script that can be run safely on production data
5. WHEN the migration is complete THEN the Payment System SHALL verify that all payments have both internal and external transaction IDs where applicable

### Requirement 8

**User Story:** As a BUFIA user, I want to see my transaction ID immediately after payment, so that I have confirmation and a reference number for my records.

#### Acceptance Criteria

1. WHEN a payment is successfully processed THEN the Payment System SHALL redirect the user to a confirmation page displaying the internal transaction ID
2. WHEN a payment confirmation page is displayed THEN the Payment System SHALL show the internal transaction ID in a prominent, easy-to-read format
3. WHEN a user receives a payment receipt THEN the Payment System SHALL include the internal transaction ID at the top of the receipt
4. THE Payment System SHALL display the internal transaction ID in a format that is easy to read aloud over the phone
5. WHEN a user views their rental history THEN the Payment System SHALL display the internal transaction ID for each paid rental
