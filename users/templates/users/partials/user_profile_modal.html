<!-- User Profile Modal -->
<div class="modal fade" id="userProfileModal" tabindex="-1" aria-labelledby="userProfileModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered modal-xl">
        <div class="modal-content">
            <div class="modal-header bg-light">
                <h5 class="modal-title" id="userProfileModalLabel"><i class="fas fa-user-circle me-2"></i>User Profile</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <div id="profile-loading" class="text-center py-5">
                    <div class="spinner-border text-primary" role="status">
                        <span class="visually-hidden">Loading...</span>
                    </div>
                    <p class="mt-2">Loading user profile...</p>
                </div>
                
                <div id="profile-content" style="display: none;">
                    <div class="row">
                        <!-- Left Column: Basic Info & Account Status -->
                        <div class="col-md-4 border-end">
                            <div class="user-profile-header text-center mb-3">
                                <div id="profile-image-container" class="mb-2">
                                    <!-- Profile image/initials will be inserted here -->
                                </div>
                                <h4 id="profile-name" class="mb-0"></h4>
                                <p id="profile-username" class="text-muted small"></p>
                                <p id="profile-role-display" class="badge bg-primary"></p>
                            </div>

                            <h5><i class="fas fa-user-shield me-1"></i> Account Info</h5>
                            <ul class="list-unstyled profile-details-list">
                                <li><strong>Email:</strong> <span id="profile-email"></span></li>
                                <li><strong>Phone:</strong> <span id="profile-phone"></span></li>
                                <li><strong>User Address:</strong> <span id="profile-user-address"></span></li>
                                <li><strong>Joined:</strong> <span id="profile-date-joined"></span></li>
                                <li><strong>Last Login:</strong> <span id="profile-last-login"></span></li>
                                <li><strong>Status:</strong> <span id="profile-status" class="fw-bold"></span></li>
                            </ul>
                            
                            <div id="managed-sectors-section" style="display:none;">
                                <h5><i class="fas fa-sitemap me-1"></i> Managed Sectors</h5>
                                <ul id="profile-managed-sectors" class="list-unstyled"></ul>
                            </div>
                        </div>

                        <!-- Right Column: Membership Details -->
                        <div class="col-md-8">
                            <ul class="nav nav-tabs mb-3" id="profileTab" role="tablist">
                                <li class="nav-item" role="presentation">
                                    <button class="nav-link active" id="membership-details-tab" data-bs-toggle="tab" data-bs-target="#membership-details" type="button" role="tab" aria-controls="membership-details" aria-selected="true">Membership</button>
                                </li>
                            </ul>
                            <div class="tab-content" id="profileTabContent">
                                <div class="tab-pane fade show active" id="membership-details" role="tabpanel" aria-labelledby="membership-details-tab">
                                    <h5><i class="fas fa-certificate me-1"></i> Membership Verification</h5>
                                    <ul class="list-unstyled profile-details-list">
                                        <li><strong>Verification Status:</strong> <span class="fw-bold">Verified</span></li>
                                        <li><strong>Form Submitted:</strong> <span>Yes</span></li>
                                        <li><strong>Form Submission Date:</strong> <span>June 04, 2025</span></li>
                                        <li><strong>Approval Date:</strong> <span>June 04, 2025</span></li>
                                        <li><strong>User Rejection Reason:</strong> <span>N/A</span></li>
                                    </ul>
                                    <hr>
                                    <h5><i class="fas fa-id-card me-1"></i> Application Details <small class="text-muted">(Most Recent)</small></h5>
                                    <ul class="list-unstyled profile-details-list">
                                        <li><strong>Application Submitted:</strong> <span>June 04, 2025</span></li>
                                        <li><strong>Is Current Application:</strong> <span>Yes</span></li>
                                        <li><strong>Application Approved:</strong> <span>Yes</span></li>
                                        <li><strong>Application Rejected:</strong> <span>No</span></li>
                                        <li><strong>Assigned Sector:</strong> <span>Sector 1</span></li>
                                        <li><strong>Reviewed By:</strong> <span>admin</span></li>
                                        <li><strong>Review Date:</strong> <span>June 04, 2025</span></li>
                                        <li><strong>App Rejection Reason:</strong> <span>N/A</span></li>
                                    </ul>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="modal-footer justify-content-between">
                <div> <!-- Action buttons on the left -->
                    <a href="#" id="profile-verify-link" class="btn btn-success" style="display:none;"><i class="fas fa-check-circle me-1"></i> Verify</a>
                    <a href="#" id="profile-reject-link" class="btn btn-warning" style="display:none;"><i class="fas fa-times-circle me-1"></i> Reject</a>
                    <a href="#" id="profile-delete-link" class="btn btn-danger" style="display:none;"><i class="fas fa-trash me-1"></i> Delete User</a>
                </div>
                <div> <!-- Standard buttons on the right -->
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                    <a href="#" id="profile-edit-link" class="btn btn-primary"><i class="fas fa-edit me-1"></i> Edit User</a>
                </div>
            </div>
        </div>
    </div>
</div>

<style>
    .profile-details-list li {
        padding: 0.3rem 0;
        display: flex;
    }
    .profile-details-list li strong {
        min-width: 180px; /* Adjust as needed */
        color: #555;
    }
    .user-profile-header .user-profile-placeholder {
        width: 100px;
        height: 100px;
        border-radius: 50%;
        background-color: var(--bs-primary);
        color: white;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 2.5rem;
        margin: 0 auto 10px auto;
    }
</style>

<script>
    document.addEventListener('DOMContentLoaded', function() {
        const userProfileModalElement = document.getElementById('userProfileModal');
        if (!userProfileModalElement) {
            console.warn("User Profile Modal HTML element not found. Modal functionality will not be available.");
            return;
        }
        const userProfileModal = new bootstrap.Modal(userProfileModalElement);
        
        function setText(id, value, defaultValue = 'N/A') {
            const el = document.getElementById(id);
            if (el) el.textContent = value || defaultValue;
        }

        function setHtml(id, value, defaultValue = 'N/A') {
            const el = document.getElementById(id);
            if (el) el.innerHTML = value || defaultValue;
        }

        function setClass(id, className, condition) {
            const el = document.getElementById(id);
            if (el) {
                el.classList.remove('text-success', 'text-danger', 'text-primary', 'text-warning', 'text-secondary'); // Clear previous classes
                if (condition && className) {
                    el.classList.add(className);
                }
            }
        }
        
        async function loadUserProfile(userId) {
            const profileContent = document.getElementById('profile-content');
            const profileLoading = document.getElementById('profile-loading');
            const profileModalLabel = document.getElementById('userProfileModalLabel');

            if (!profileContent || !profileLoading || !profileModalLabel) {
                console.error("Modal content/loading/label elements not found. Cannot load profile.");
                return;
            }
            
            profileContent.style.display = 'none';
            profileLoading.style.display = 'block';
            profileLoading.innerHTML = `<div class="spinner-border text-primary" role="status"><span class="visually-hidden">Loading...</span></div><p class="mt-2">Loading user profile...</p>`;
            profileModalLabel.innerHTML = '<i class="fas fa-user-circle me-2"></i>User Profile';
            
            // Reset tab to first tab
            const firstTab = bootstrap.Tab.getInstance(document.getElementById('membership-details-tab'));
            if (firstTab) firstTab.show(); 
            else { 
                new bootstrap.Tab(document.getElementById('membership-details-tab')).show(); 
            }

            userProfileModal.show();
            
            try {
                const response = await fetch(`/api/user/${userId}/profile/`);
                if (!response.ok) {
                    let errorMsg = `Error: ${response.status}`;
                    try { const errorData = await response.json(); errorMsg = errorData.error || errorMsg; } catch (e) { /* Ignore */ }
                    throw new Error(errorMsg);
                }
                const data = await response.json();
                
                profileModalLabel.innerHTML = `<i class="fas fa-user-circle me-2"></i>Profile: ${data.fullName || data.username}`;
                
                // User Profile Header
                setHtml('profile-image-container', `<div class="user-profile-placeholder">${data.initials || 'U'}</div>`);
                setText('profile-name', data.fullName);
                setText('profile-username', data.username ? `@${data.username}` : 'N/A');
                setText('profile-role-display', data.role);
                
                // Account Info (Left Column)
                setText('profile-email', data.email);
                setText('profile-phone', data.phoneNumber);
                setText('profile-user-address', data.userAddress);
                setText('profile-date-joined', data.dateJoined);
                setText('profile-last-login', data.lastLogin);
                setText('profile-status', data.statusText);
                setClass('profile-status', data.isActive ? 'text-success' : 'text-danger', true);

                // Managed Sectors
                const managedSectorsSection = document.getElementById('managed-sectors-section');
                const managedSectorsList = document.getElementById('profile-managed-sectors');
                if (data.managedSectors && data.managedSectors.length > 0) {
                    managedSectorsList.innerHTML = data.managedSectors.map(s => `<li><i class="fas fa-map-marker-alt me-1 text-muted"></i> ${s}</li>`).join('');
                    managedSectorsSection.style.display = 'block';
                } else {
                    managedSectorsSection.style.display = 'none';
                }

                // Footer Action Buttons
                const editLink = document.getElementById('profile-edit-link');
                if (editLink) editLink.href = data.editUrl || '#';
                
                const verifyLink = document.getElementById('profile-verify-link');
                if (verifyLink) { verifyLink.href = data.verifyUrl || '#'; verifyLink.style.display = data.verifyUrl ? 'inline-block' : 'none'; }
                
                const rejectLink = document.getElementById('profile-reject-link');
                if (rejectLink) { rejectLink.href = data.rejectUrl || '#'; rejectLink.style.display = data.rejectUrl ? 'inline-block' : 'none'; }

                const deleteLink = document.getElementById('profile-delete-link');
                if (deleteLink) { deleteLink.href = data.deleteUrl || '#'; deleteLink.style.display = data.deleteUrl ? 'inline-block' : 'none'; }
                
                // Explicitly ensure the membership tab and pane are active and visible
                const membershipTabButton = document.getElementById('membership-details-tab');
                const membershipPane = document.getElementById('membership-details');
                if (membershipTabButton && membershipPane) {
                    // In a single-tab scenario, these should already be active from HTML,
                    // but this ensures they are if anything went awry.
                    membershipTabButton.classList.add('active');
                    membershipTabButton.setAttribute('aria-selected', 'true');
                    membershipPane.classList.add('show', 'active');
                } else {
                    console.error("Membership tab button or pane not found for explicit activation.");
                }

                profileLoading.style.display = 'none';
                profileContent.style.display = 'block';
                
            } catch (error) {
                console.error("Failed to load user profile:", error);
                if (profileLoading) {
                    profileLoading.innerHTML = `<p class="text-danger p-3">Failed to load profile: ${error.message}</p>`;
                    profileLoading.style.display = 'block';
                }
                if (profileContent) profileContent.style.display = 'none';
            }
        }

        document.body.addEventListener('click', function(event) {
            const button = event.target.closest('.view-profile-btn');
            if (button) {
                event.preventDefault();
                event.stopPropagation();
                const userId = button.dataset.userId;
                if (userId) {
                    loadUserProfile(userId);
                } else {
                    console.error("User ID not found on view profile button.");
                }
            }
        });
    });
</script> 